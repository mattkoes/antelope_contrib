
This code is now an incredible mess.  It needs to be completely rewritten.
Please don't try to fix it, or use it as an example.
